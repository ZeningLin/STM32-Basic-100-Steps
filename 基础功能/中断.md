# 中断

## NVIC
### 抢占优先级与响应优先级
- 抢占优先级高的中断可以打断抢占优先级低的中断
- 抢占优先级相同，高响应优先级**不能**打断低响应优先级
- 抢占优先级相同，两个中断同时发生时响应优先级高的优先执行
- 两个中断的抢占和响应优先级相同，则哪个先发生就哪个先执行
- 优先级数越小优先级越高

### NVIC中断优先级分组
- 优先级的分组在寄存器`SCB->AIRCR`的[10:8]中设置(`NVIC_PriorityGruopConfig(uint32_t NVIC_PriorityGroup_x)`)；抢占优先级与响应优先级的值在IP寄存器的[7:4]位中存放
- IP寄存器一共240个，与CM3内核可编程中断一一对应，STM32没有全部使用，但是依旧保留240个；每个IP寄存器为8位，4个组成32位，高四位有效，低四位不使用

|优先级分组|AIRCR[10:8]|IP[7:4]中抢占优先级：响应优先级|
|--|--|--|
|NVIC_PriorityGroup_0|111|0:4|
|NVIC_PriorityGroup_1|110|1:3|
|NVIC_PriorityGroup_2|101|2:2|
|NVIC_PriorityGroup_3|100|3:1|
|NVIC_PriorityGroup_4|011|4:0|

- 一般情况下，系统代码执行过程中只设置一次中断优先级分组，随意改变会导致中断管理混乱

### 中断优先级设置
#### NVIC_InitTypeDef
```C
typedef struct{
    uint8_t NVIC_IRQChannel;    // 设置中断通道
    uint8_t NVIC_IRQChannelPreemptionPriority;  // 设置响应优先级
    uint8_t NVIC_IRQChannelSubPriority; //设置抢占优先级
    FunctionState NVIC_IRQChannelCmd;   // 使能、失能
}NVIC_InitTypeDef;
```

初始化代码示例（以串口1为例）：
```C
NVIC_PriorityGruopConfig(uint32_t NVIC_PriorityGroup_2);    // 设置优先级分组为2

NVIC_InitTypeDef NVIC_InitStructure;
NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;   // 设置通道为串口1
NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;    // 抢占优先级设置为1
NVIC_InitStructure.NVIC_IRQCHannelSubPriority = 2;  // 响应优先级设置为2
NVIC_InitStructure,NVIC_IRQChannelCmd = ENABLE; // 中断使能
NVIC_Init(&NVIC_InitStructure);
```